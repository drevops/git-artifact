machine:
  php:
    version: 7.1.6

dependencies:
  cache_directories:
    - ~/.composer/cache
  pre:
    - rm /opt/circleci/php/$(phpenv global)/etc/conf.d/xdebug.ini

test:
  pre:
    - |
        git config --global user.email "$DEPLOY_USER_EMAIL" && git config --global user.name "$DEPLOY_USER_NAME"
        mkdir -p ~/.ssh/ && echo -e "Host github.com\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
        DEPLOY_SSH_FILE="${DEPLOY_SSH_FINGERPRINT//:}" && DEPLOY_SSH_FILE="id_${DEPLOY_SSH_FILE//\"}" && ssh-add -D && ssh-add ~/.ssh/$DEPLOY_SSH_FILE
  override:
    - composer cs
    - composer test

deployment:
  demo:
    branch: master
    commands:
      # Planting test asset file.
      - touch test-file-$(date "+%Y%m%d-%H%M%S").txt

      # Demonstration of deployment in 'force-push' mode.
      - |
          vendor/bin/robo artefact \
            git@github.com:integratedexperts/robo-git-artefact-destination.git \
            --mode=force-push \
            --branch=mode-force-push \
            --report=$HOME/report-mode-force-push.txt \
            --push
      - |
          DEPLOY_BRANCH=$(sed -n 's/Remote branch://p' $HOME/report-mode-force-push.txt | sed 's/ //g')
          echo "Deployed to $DEPLOY_BRANCH"

      # Demonstration of deployment in 'branch' mode.
      - |
          vendor/bin/robo artefact \
            git@github.com:integratedexperts/robo-git-artefact-destination.git \
            --mode=branch \
            --branch=mode-branch-[timestamp:Y-m-d_H-i-s] \
            --report=$HOME/report-mode-branch.txt \
            --push
      - |
          DEPLOY_BRANCH=$(sed -n 's/Remote branch://p' $HOME/report-mode-branch.txt | sed 's/ //g')
          echo "Deployed to $DEPLOY_BRANCH"
